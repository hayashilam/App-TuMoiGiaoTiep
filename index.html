<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>T·ª´ M·ªõi Pro V21 U - 3D Flip Edition</title>
    <style>
        :root { --primary: #3b82f6; --bg: #f8fafc; --red: #ff4757; --gray: #94a3b8; --success: #22c55e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
        html, body { width: 100%; height: 100dvh; overflow: hidden; background: #e2e8f0; font-family: -apple-system, system-ui, sans-serif; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 500px; height: 100dvh; background: var(--bg); display: flex; flex-direction: column; padding: env(safe-area-inset-top) 15px env(safe-area-inset-bottom) 15px; box-shadow: 0 0 50px rgba(0,0,0,0.1); position: relative; }
        
        .pg-bar-wrap { width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; margin-top: 5px; overflow: hidden; }
        #pg-bar-fill { width: 0%; height: 100%; background: var(--primary); transition: width 0.3s; }

        .header { flex-shrink: 0; padding-top: 10px; }
        .top-row { display: flex; justify-content: space-between; align-items: center; height: 40px; }
        .tab-menu { display: flex; justify-content: center; gap: 20px; margin-top: 5px; }
        .tab-link { font-weight: bold; color: var(--gray); font-size: 14px; cursor: pointer; padding-bottom: 8px; position: relative; }
        .tab-link.active { color: var(--primary); }
        .tab-link.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 3px; background: var(--primary); border-radius: 3px; }
        
        .controls { display: flex; align-items: center; justify-content: center; gap: 5px; margin: 15px 0; }
        .m-btn { min-width: 42px; height: 32px; padding: 0 5px; border-radius: 8px; border: 1px solid #e2e8f0; background: #fff; font-weight: bold; color: var(--primary); font-size: 11px; cursor: pointer; }
        .m-btn.active { background: var(--red); color: #fff; border-color: var(--red); }
        .ctrl-btn { width: 36px; height: 36px; border-radius: 50%; border: none; background: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.08); font-size: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; }

        .main-content { flex: 1; display: flex; flex-direction: column; justify-content: flex-end; align-items: center; padding-bottom: 20px; }
        
        /* Box styles */
        .box-wrapper { width: 100%; height: 240px; perspective: 1000px; margin-bottom: 30px; cursor: pointer; }
        .box-inner { position: relative; width: 100%; height: 100%; text-align: center; transition: transform 0.6s; transform-style: preserve-3d; }
        .box-wrapper.is-flipped .box-inner { transform: rotateY(180deg); }
        .box-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 15px; border-radius: 35px; box-shadow: 0 15px 35px rgba(0,0,0,0.05); background: #fff; }
        .box-back { background: var(--primary); color: #fff; transform: rotateY(180deg); }
        
        #main-txt-container { width: 100%; display: flex; justify-content: center; align-items: center; overflow: hidden; }
        #main-txt { font-weight: 900; color: #1e293b; white-space: nowrap; display: inline-block; line-height: 1; }
        #sub-txt { font-size: 18px; color: var(--gray); margin-top: 10px; font-weight: 500; min-height: 20px; }
        #back-txt { font-weight: 900; line-height: 1.1; }

        .review-actions { display: flex; gap: 60px; margin-bottom: 40px; }
        .action-btn { width: 70px; height: 70px; border-radius: 25px; border: 2.5px solid #e2e8f0; background: #fff; display: flex; align-items: center; justify-content: center; font-size: 32px; cursor: pointer; }
        .btn-ok { color: var(--success); border-color: var(--success); }
        .btn-no { color: var(--red); border-color: var(--red); }

        .opt-btn { background: #fff; border: 1.5px solid #e2e8f0; border-radius: 18px; height: 50px; font-size: 16px; font-weight: 600; width: 100%; margin-bottom: 10px; color: #334155; cursor: pointer; }
        
        #input-quiz-wrap { width: 100%; margin-bottom: 20px; display: none; }
        #user-input { width: 100%; height: 55px; border-radius: 15px; border: 2px solid #e2e8f0; text-align: center; font-size: 20px; font-weight: bold; outline: none; transition: all 0.2s; }

        .bottom-nav { flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; padding: 10px 0; }
        .nav-btn { width: 50px; height: 50px; border-radius: 50%; border: none; background: #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.08); font-size: 20px; color: var(--primary); display: flex; align-items: center; justify-content: center; cursor: pointer; }

        #screen-range { position: absolute; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:100; display:none; flex-direction:column; padding:40px 20px; }
        .range-box { background:#fff; padding:30px; border-radius:25px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .slider-wrap { margin: 25px 0; }
        input[type=range] { width:100%; margin: 15px 0; }
        .range-val { font-size: 24px; font-weight: bold; color: var(--primary); }
        .start-btn { width:100%; height:60px; background:#1e293b; color:#fff; border:none; border-radius:15px; font-size:18px; font-weight:bold; margin-top:20px; }

        /* PH·∫¶N CH·ªàNH S·ª¨A: M·ªñI H√ÄNG 1 GI√ÅO TR√åNH */
        .book-item-btn {
            width: 100%;
            padding: 22px;
            border-radius: 20px;
            margin-bottom: 12px;
            color: #fff;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
            transition: transform 0.1s;
        }
        .book-item-btn:active { transform: scale(0.98); }

        .review-all-btn { width: 100%; padding: 20px; background: #fff; border: 2px dashed var(--red); color: var(--red); border-radius: 20px; font-weight: bold; font-size: 16px; margin-bottom: 20px; cursor: pointer; display: none; align-items: center; justify-content: center; gap: 10px; }
    </style>
</head>
<body>
<div class="container">
    <div id="screen-books" style="overflow-y:auto; padding:20px 0;">
        <h2 style="text-align:center; margin-bottom:25px; color: #1e293b;">Gi√°o tr√¨nh</h2>
        <div id="review-all-area" style="padding: 0 5px;">
            <button id="btn-master-review" class="review-all-btn" onclick="startMasterReview()">
                <span>üö® √îN T·∫¨P T·ª™ SAI (T·∫§T C·∫¢)</span>
                <small id="review-count-badge" style="background:var(--red); color:#fff; padding:2px 8px; border-radius:10px; font-size:12px;">0</small>
            </button>
        </div>
        <div id="book-list" style="padding: 0 5px;"></div>
    </div>

    <div id="screen-range">
        <button onclick="document.getElementById('screen-range').style.display='none'" style="background:none; border:none; font-size:18px; color:var(--gray); text-align:left; margin-bottom:20px;">‚Üê Back</button>
        <div class="range-box">
            <h3 id="range-title" style="margin-bottom:10px;">Select Range</h3>
            <div class="slider-wrap">
                <p>T·ª´ b√†i: <span id="val-from" class="range-val">1</span></p>
                <input type="range" id="slide-from" min="1" max="1" value="1" oninput="updateRangeLabel()">
            </div>
            <div class="slider-wrap">
                <p>ƒê·∫øn b√†i: <span id="val-to" class="range-val">1</span></p>
                <input type="range" id="slide-to" min="1" max="1" value="1" oninput="updateRangeLabel()">
            </div>
            <p id="total-words-hint" style="color:var(--gray); font-size:14px; margin-bottom:20px;"></p>
            <button class="start-btn" onclick="confirmRange()">Start Learning</button>
        </div>
    </div>
    
    <div id="screen-study" style="display:none; height:100%; flex-direction:column;">
        <div class="header">
            <div class="top-row">
                <button onclick="location.reload()" style="background:none; border:none; font-size:24px; color:var(--gray)">‚úï</button>
                <div style="display:flex; align-items:center; gap:10px;">
                    <button id="btn-review-toggle" onclick="toggleReviewMode()" style="background:none; border:none; font-size:20px; color:var(--gray)">üîÑ</button>
                    <b id="progress" style="color:var(--gray); font-size: 14px;">0/0</b>
                </div>
                <div style="width:24px"></div>
            </div>
            <div class="pg-bar-wrap"><div id="pg-bar-fill"></div></div>
            <div class="tab-menu">
                <div id="t-card" class="tab-link active" onclick="setMode('card')">H·ªçc th·∫ª</div>
                <div id="t-quiz" class="tab-link" onclick="setMode('quiz')">Tr·∫Øc nghi·ªám</div>
                <div id="t-input" class="tab-link" onclick="setMode('input')">Luy·ªán vi·∫øt</div>
            </div>
            <div class="controls">
                <button id="m-all" class="m-btn active" onclick="viewMode('all')">ÂÖ®</button>
                <button id="m-hi" class="m-btn" onclick="viewMode('hi')">„Å≤</button>
                <button id="m-vn" class="m-btn" onclick="viewMode('vn')">VN</button>
                <button id="m-hiv" class="m-btn" onclick="viewMode('hiv')">„Å≤/V</button>
                <button class="ctrl-btn" onclick="shuffleData()">üîÄ</button>
                <button class="ctrl-btn" onclick="say()">üîä</button>
            </div>
        </div>

        <div class="main-content">
            <div id="display-box" class="box-wrapper" onclick="flip()">
                <div class="box-inner" id="box-inner">
                    <div class="box-face box-front">
                        <div id="main-txt-container"><span id="main-txt"></span></div>
                        <div id="sub-txt"></div>
                    </div>
                    <div class="box-face box-back">
                        <div id="back-txt"></div>
                    </div>
                </div>
            </div>
            
            <div id="area-actions" class="review-actions">
                <div class="action-btn btn-no" onclick="markReview(true)">‚úò</div>
                <div class="action-btn btn-ok" onclick="markReview(false)">‚úî</div>
            </div>

            <div id="area-quiz" style="display:none; width:100%; padding-bottom:10px;"><div id="quiz-options"></div></div>

            <div id="input-quiz-wrap">
                <input type="text" 
                       id="user-input" 
                       placeholder="Nh·∫≠p hiragana..." 
                       autocomplete="off" 
                       autocorrect="off" 
                       autocapitalize="off" 
                       spellcheck="false">
            </div>
        </div>

        <div class="bottom-nav">
            <button class="nav-btn" onclick="go(-1)">‚Äπ</button>
            <span id="tag-lv" style="color:var(--gray); font-weight:bold; font-size:13px;"></span>
            <button class="nav-btn" onclick="go(1)">‚Ä∫</button>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbww4a3Yu9xht0nBQHiTYHR9CApNstB9NQ-2840R6J9nB3tBi7Oh4xsG48a4UqQF2i6A_A/exec";
    let db = [], filtered = [], allOfBook = [], reviewList = [], cur = 0, appMode = 'card', displayMode = 'all', isFlipped = false, isReviewMode = false;

    const inputField = document.getElementById('user-input');
    
    function clearInputCompletely() {
        inputField.value = "";
        inputField.blur(); 
        setTimeout(() => {
            inputField.value = ""; 
            inputField.focus();
        }, 10);
    }

    inputField.addEventListener('input', (e) => {
        const correct = filtered[cur][3];
        const val = inputField.value.trim();
        if (val === correct) {
            inputField.style.borderColor = 'var(--success)';
            if(isReviewMode) markReview(false, false); 
            setTimeout(() => {
                if (cur < filtered.length - 1) { cur++; clearInputCompletely(); update(); }
                else { alert("Ho√†n th√†nh!"); location.reload(); }
            }, 200);
        } else if (val.length >= correct.length && val !== correct) {
            inputField.style.borderColor = 'var(--red)';
            markReview(true, false); 
        }
    });

    function adjustFontSize(elementId, containerId, maxFs) {
        const el = document.getElementById(elementId);
        const container = document.getElementById(containerId);
        if (!el || !container) return;
        let fs = maxFs;
        el.style.fontSize = fs + 'px';
        while (el.offsetWidth > container.offsetWidth - 20 && fs > 10) {
            fs -= 2;
            el.style.fontSize = fs + 'px';
        }
    }

    async function load() {
        try {
            const res = await fetch(SCRIPT_URL + '?t=' + Date.now());
            const data = await res.json();
            db = data.slice(1).filter(r => r[0] && r[0].trim() !== "");
            reviewList = JSON.parse(localStorage.getItem('review_data') || "[]");
            renderBooks();
            updateReviewButton();
        } catch(e) { document.getElementById('book-list').innerText = "L·ªói k·∫øt n·ªëi."; }
    }

    function renderBooks() {
        const lvs = [...new Set(db.map(r => r[0]))];
        const colors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444'];
        document.getElementById('book-list').innerHTML = lvs.map((l, i) => `<div class="book-item-btn" style="background:${colors[i%4]};" onclick="openRangePicker('${l}')">${l}</div>`).join('');
    }

    function updateReviewButton() {
        const btn = document.getElementById('btn-master-review');
        const badge = document.getElementById('review-count-badge');
        if (reviewList.length > 0) {
            btn.style.display = 'flex';
            badge.innerText = reviewList.length;
        } else {
            btn.style.display = 'none';
        }
    }

    function startMasterReview() {
        filtered = db.filter(r => reviewList.includes(r[2]));
        if (filtered.length === 0) return;
        isReviewMode = true;
        document.getElementById('screen-books').style.display = 'none';
        document.getElementById('screen-study').style.display = 'flex';
        document.getElementById('tag-lv').innerText = "üö® √în t·∫≠p t·ªïng h·ª£p";
        document.getElementById('btn-review-toggle').style.color = 'var(--red)';
        cur = 0; update();
    }

    function openRangePicker(bookName) {
        allOfBook = db.filter(r => r[0] === bookName);
        const lessons = [...new Set(allOfBook.map(r => r[1]))].map(Number).sort((a,b)=>a-b);
        const minL = Math.min(...lessons), maxL = Math.max(...lessons);
        document.getElementById('range-title').innerText = bookName;
        const sFrom = document.getElementById('slide-from'), sTo = document.getElementById('slide-to');
        sFrom.min = sTo.min = minL; sFrom.max = sTo.max = maxL;
        sFrom.value = minL; sTo.value = maxL;
        updateRangeLabel();
        document.getElementById('screen-range').style.display = 'flex';
        document.getElementById('tag-lv').innerText = bookName;
    }

    function updateRangeLabel() {
        const f = document.getElementById('slide-from').value;
        const t = document.getElementById('slide-to').value;
        document.getElementById('val-from').innerText = f;
        document.getElementById('val-to').innerText = t;
        const count = allOfBook.filter(r => Number(r[1]) >= f && Number(r[1]) <= t).length;
        document.getElementById('total-words-hint').innerText = `T·ªïng c·ªông: ${count} t·ª´ v·ª±ng`;
    }

    function confirmRange() {
        const f = Number(document.getElementById('slide-from').value);
        const t = Number(document.getElementById('slide-to').value);
        filtered = allOfBook.filter(r => Number(r[1]) >= f && Number(r[1]) <= t);
        isReviewMode = false;
        document.getElementById('screen-range').style.display = 'none';
        document.getElementById('screen-books').style.display = 'none';
        document.getElementById('screen-study').style.display = 'flex';
        cur = 0; update();
    }

    function shuffleData() { filtered.sort(() => Math.random() - 0.5); cur = 0; update(); }

    function update() {
        if(!filtered[cur]) return;
        const item = filtered[cur];
        document.getElementById('progress').innerText = `${cur + 1} / ${filtered.length}`;
        document.getElementById('pg-bar-fill').style.width = ((cur + 1) / filtered.length * 100) + '%';
        
        isFlipped = false;
        document.getElementById('display-box').classList.remove('is-flipped');
        
        const mainTxt = document.getElementById('main-txt');
        const subTxt = document.getElementById('sub-txt');
        const backTxt = document.getElementById('back-txt');

        if (displayMode === 'all') { mainTxt.innerText = item[2]; subTxt.innerText = item[3]; backTxt.innerText = item[4]; }
        else if (displayMode === 'hi') { mainTxt.innerText = item[2]; subTxt.innerText = ""; backTxt.innerText = item[3]; }
        else if (displayMode === 'vn') { mainTxt.innerText = item[2]; subTxt.innerText = ""; backTxt.innerText = item[4]; }
        else if (displayMode === 'hiv') { mainTxt.innerText = item[3]; subTxt.innerText = ""; backTxt.innerText = item[4]; }
        
        adjustFontSize('main-txt', 'main-txt-container', 120);
        adjustFontSize('back-txt', 'box-inner', 70);

        if(appMode === 'quiz') renderQuiz();
        if(appMode === 'input') {
            inputField.value = "";
            inputField.style.borderColor = "#e2e8f0";
            setTimeout(() => inputField.focus(), 50);
        }
    }

    function flip() {
        if(appMode !== 'card') return;
        isFlipped = !isFlipped;
        document.getElementById('display-box').classList.toggle('is-flipped');
    }

    function renderQuiz() {
        const item = filtered[cur];
        let correct = (displayMode === 'hi' ? item[3] : item[4]);
        let others = db.filter(r => (displayMode === 'hi' ? r[3] : r[4]) !== correct).map(r => (displayMode === 'hi' ? r[3] : r[4]));
        let options = [correct, ...others.sort(() => 0.5 - Math.random()).slice(0, 3)].sort(() => 0.5 - Math.random());
        document.getElementById('quiz-options').innerHTML = options.map(opt => `<button class="opt-btn" onclick="checkQuiz(this, '${opt}', '${correct}')">${opt}</button>`).join('');
    }

    function checkQuiz(btn, sel, cor) {
        if(sel === cor) {
            btn.style.background = 'var(--success)'; btn.style.color = '#fff';
            if(isReviewMode) markReview(false, false);
            setTimeout(() => { if(cur < filtered.length - 1) { cur++; update(); } }, 500);
        } else { 
            btn.style.background = 'var(--red)'; btn.style.color = '#fff'; 
            markReview(true, false);
        }
    }

    function markReview(needsReview, moveNext = true) {
        if(!filtered[cur]) return;
        const word = filtered[cur][2];
        if(needsReview) {
            if(!reviewList.includes(word)) reviewList.push(word);
        } else {
            reviewList = reviewList.filter(w => w !== word);
        }
        localStorage.setItem('review_data', JSON.stringify(reviewList));
        updateReviewButton();

        if(moveNext) {
            if(cur < filtered.length - 1) { cur++; update(); } 
            else { 
                alert(isReviewMode ? "ƒê√£ duy·ªát h·∫øt t·ª´ sai!" : "Xong b√†i h·ªçc!"); 
                location.reload();
            }
        }
    }

    function setMode(m) {
        appMode = m;
        document.getElementById('t-card').className = 'tab-link ' + (m === 'card' ? 'active' : '');
        document.getElementById('t-quiz').className = 'tab-link ' + (m === 'quiz' ? 'active' : '');
        document.getElementById('t-input').className = 'tab-link ' + (m === 'input' ? 'active' : '');
        
        document.getElementById('area-actions').style.display = (m === 'card') ? 'flex' : 'none';
        document.getElementById('area-quiz').style.display = (m === 'quiz') ? 'block' : 'none';
        document.getElementById('input-quiz-wrap').style.display = (m === 'input') ? 'block' : 'none';
        update();
    }

    function viewMode(v) {
        displayMode = v;
        ['all','hi','vn','hiv'].forEach(m => {
            const el = document.getElementById('m-'+m);
            if(el) el.className = 'm-btn ' + (v === m ? 'active' : '');
        });
        update();
    }

    function toggleReviewMode() {
        isReviewMode = !isReviewMode;
        document.getElementById('btn-review-toggle').style.color = isReviewMode ? 'var(--red)' : 'var(--gray)';
        if(isReviewMode) {
            filtered = db.filter(r => reviewList.includes(r[2]));
            if(filtered.length === 0) { alert("Kh√¥ng c√≥ t·ª´ n√†o c·∫ßn √¥n t·∫≠p!"); isReviewMode = false; return; }
        } else {
            filtered = allOfBook;
        }
        cur = 0; update();
    }

    function go(d) { cur = (cur + d + filtered.length) % filtered.length; update(); }
    function say() { const m = new SpeechSynthesisUtterance(filtered[cur][2]); m.lang = 'ja-JP'; window.speechSynthesis.speak(m); }
    load();
</script>
</body>
</html>
